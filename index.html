<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ระบบจองคิวถ่ายภาพ</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0"
        }
    }
    </script>

    <!-- 3. Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* ป้องกันการ double-tap zoom บนมือถือ */
        button { touch-action: manipulation; }
    </style>
</head>
<body class="bg-gray-100 text-slate-800">
    <div id="root"></div>

    <!-- 4. React Code -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, getDoc } from 'firebase/firestore';
        import { Clock, Users, User, Calendar, CheckCircle, AlertCircle, Trash2, X, Menu } from 'lucide-react';

        // --- Config Firebase ---
        const isPreview = typeof __firebase_config !== 'undefined';
        
        let firebaseConfig;
        let collectionPath;

        if (isPreview) {
            firebaseConfig = JSON.parse(__firebase_config);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            collectionPath = `artifacts/${appId}/public/data/photo_bookings`;
        } else {
            // โหมด GitHub: ใช้ Config เดิมของคุณ
            firebaseConfig = {
                apiKey: "AIzaSyBWDvn67-_uW-OagSezI16kjbANVa4yAJI",
                authDomain: "my-queue-system-5b1d6.firebaseapp.com",
                projectId: "my-queue-system-5b1d6",
                storageBucket: "my-queue-system-5b1d6.firebasestorage.app",
                messagingSenderId: "57979958638",
                appId: "1:57979958638:web:82d71cc5654f304764fd7f",
                measurementId: "G-WNP7J2F96C"
            };
            collectionPath = "photo_bookings"; 
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // กำหนดระยะห่างแต่ละรอบ
        const INTERVAL_MINUTES = 5;

        // ฟังก์ชันสร้างช่วงเวลาแบบกำหนดหลายช่วง (Multiple Ranges)
        const generateTimeSlots = () => {
            const slots = [];
            // กำหนดช่วงเวลาที่ต้องการเปิดจองที่นี่
            const ranges = [
                { start: "11:30", end: "12:30" },
                { start: "15:30", end: "17:00" }
            ];

            ranges.forEach(range => {
                let current = new Date(`2024-01-01T${range.start}:00`);
                const end = new Date(`2024-01-01T${range.end}:00`);

                while (current < end) {
                    slots.push(current.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false }));
                    current.setMinutes(current.getMinutes() + INTERVAL_MINUTES);
                }
            });
            
            return slots;
        };

        function PhotoBookingApp() {
            const [user, setUser] = useState(null);
            const [bookings, setBookings] = useState({});
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState("");
            const [successMsg, setSuccessMsg] = useState("");
            
            const [formData, setFormData] = useState({ name: "", group: "" });
            const [selectedTime, setSelectedTime] = useState(null);

            // Modal State
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [timeToDelete, setTimeToDelete] = useState(null);

            const timeSlots = generateTimeSlots();
            const groups = [
                "Editorial G1", "Editorial G2", "Editorial G3", "Editorial G4", "Editorial G5",
                "Editorial G6", "Editorial G7", "Editorial G8", "Editorial G9", "Editorial G10",
                "Editorial G11", "Editorial G12", "Editorial G13", "Editorial G14", "Editorial G15",
                "Editorial G16", "Editorial G17", "Editorial G18",
                "Production G1", "Production G2", "Production G3", "Production G4", "Production G5", "Production G6",
                "Admin", "IT", "Finance", "HR", "Conference", "Design", "Training", "Proceedings", "Public Service"
            ];

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth Error:", err);
                        setError("เชื่อมต่อระบบไม่สำเร็จ");
                    }
                };
                initAuth();
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user && isPreview) return;
                if (!collectionPath) return;

                const q = collection(db, collectionPath);
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = {};
                    snapshot.forEach((doc) => { data[doc.id] = doc.data(); });
                    setBookings(data);
                    setLoading(false);
                }, (err) => {
                    if (err.code !== 'permission-denied') setError("โหลดข้อมูลไม่สำเร็จ");
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user]);

            const handleInputChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));

            const handleBooking = async () => {
                setError(""); setSuccessMsg("");
                if (!formData.name.trim() || !formData.group || !selectedTime) return setError("กรุณากรอกข้อมูลให้ครบ");
                if (bookings[selectedTime]) { setSelectedTime(null); return setError("เวลานี้ถูกจองไปแล้ว"); }

                try {
                    setLoading(true);
                    const docRef = doc(db, collectionPath, selectedTime);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) { setSelectedTime(null); setLoading(false); return setError("เสียใจด้วย! เวลานี้ถูกจองไปแล้ว"); }

                    await setDoc(docRef, {
                        name: formData.name,
                        group: formData.group,
                        timestamp: new Date().toISOString(),
                        bookedByUserId: user?.uid
                    });
                    setSuccessMsg(`จองคิวเวลา ${selectedTime} สำเร็จ!`);
                    setFormData({ name: "", group: "" });
                    setSelectedTime(null);
                    
                    // เลื่อนหน้าจอกลับมาที่ข้อความสำเร็จบนมือถือ
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    
                } catch (err) { setError("บันทึกไม่สำเร็จ"); } 
                finally { setLoading(false); }
            };

            const openDeleteModal = (time) => {
                setTimeToDelete(time);
                setIsModalOpen(true);
            };

            const confirmDelete = async () => {
                if (!timeToDelete) return;
                try {
                    await deleteDoc(doc(db, collectionPath, timeToDelete));
                    setSuccessMsg(`ยกเลิกคิวเวลา ${timeToDelete} แล้ว`);
                } catch (err) {
                    setError("ลบข้อมูลไม่สำเร็จ");
                } finally {
                    setIsModalOpen(false);
                    setTimeToDelete(null);
                }
            };

            if (loading && !bookings) return <div className="min-h-screen flex items-center justify-center text-indigo-600 font-medium">กำลังโหลดระบบ...</div>;

            return (
                <div className="min-h-screen pb-10">
                    {/* Responsive Container: ปรับขนาดตามหน้าจอ - ขยายให้กว้างขึ้นสำหรับ Full HD */}
                    <div className="w-full max-w-[1800px] mx-auto bg-white shadow-xl md:rounded-b-2xl md:mt-4 overflow-hidden">
                        
                        {/* Header */}
                        <div className="bg-indigo-600 p-4 sm:p-6 text-white sticky top-0 z-30 shadow-md md:relative">
                            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                                <div className="flex items-center gap-3">
                                    <Clock className="w-6 h-6 sm:w-8 sm:h-8" />
                                    <h1 className="text-xl sm:text-2xl md:text-3xl font-bold">ระบบจองคิวถ่ายภาพ</h1>
                                </div>
                                <div className="bg-white/20 px-3 py-1 rounded-full text-xs sm:text-sm font-medium backdrop-blur-sm self-start sm:self-auto">
                                    5 นาที / กลุ่ม
                                </div>
                            </div>
                        </div>

                        <div className="p-4 sm:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8 items-start">
                            
                            {/* Left Column: Form (Sticky on Desktop) */}
                            <div className="lg:col-span-4 space-y-4 lg:sticky lg:top-8">
                                <div className="bg-slate-50 p-4 sm:p-5 rounded-xl border border-slate-200 shadow-sm">
                                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2 text-indigo-900">
                                        <User className="w-5 h-5 text-indigo-600" /> ข้อมูลผู้จอง
                                    </h2>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-600 mb-1">ชื่อ-นามสกุล</label>
                                            <input type="text" name="name" value={formData.name} onChange={handleInputChange} placeholder="เช่น สมชาย ใจดี" className="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition text-base" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-600 mb-1">สังกัด / กลุ่ม</label>
                                            <div className="relative">
                                                <Users className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
                                                <select name="group" value={formData.group} onChange={handleInputChange} className="w-full pl-10 pr-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none bg-white text-base">
                                                    <option value="">-- เลือกกลุ่ม --</option>
                                                    {groups.map(g => <option key={g} value={g}>{g}</option>)}
                                                </select>
                                            </div>
                                        </div>

                                        {/* Status Message Area */}
                                        <div className="min-h-[20px]">
                                            {selectedTime && (
                                                <div className="bg-indigo-50 text-indigo-700 p-3 rounded-lg text-sm flex items-center gap-2 border border-indigo-100 animate-in slide-in-from-top-2">
                                                    <Clock className="w-4 h-4 shrink-0" /> 
                                                    <span>เลือกเวลา: <strong>{selectedTime} น.</strong></span>
                                                </div>
                                            )}
                                            {error && (
                                                <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm flex items-start gap-2 border border-red-100 animate-pulse">
                                                    <AlertCircle className="w-5 h-5 shrink-0 mt-0.5" />
                                                    <span>{error}</span>
                                                </div>
                                            )}
                                            {successMsg && (
                                                <div className="bg-green-50 text-green-700 p-3 rounded-lg text-sm flex items-start gap-2 border border-green-100 animate-in fade-in">
                                                    <CheckCircle className="w-5 h-5 shrink-0 mt-0.5" />
                                                    <span>{successMsg}</span>
                                                </div>
                                            )}
                                        </div>

                                        <button 
                                            onClick={handleBooking} 
                                            disabled={!selectedTime || !formData.name || !formData.group || loading} 
                                            className={`w-full py-3.5 rounded-xl font-bold text-base shadow-md transition-all active:scale-95 flex items-center justify-center gap-2
                                            ${(!selectedTime || !formData.name || !formData.group) 
                                                ? 'bg-gray-200 text-gray-400 cursor-not-allowed' 
                                                : 'bg-indigo-600 text-white hover:bg-indigo-700 hover:shadow-lg'
                                            }`}
                                        >
                                            {loading ? 'กำลังบันทึก...' : 'ยืนยันการจอง'}
                                        </button>
                                    </div>
                                </div>
                                <div className="text-xs text-gray-400 text-center px-2">
                                    * กรุณาเลือกเวลาจากตารางด้านขวา (หรือด้านล่างบนมือถือ)
                                </div>
                            </div>

                            {/* Right Column: Time Slots */}
                            <div className="lg:col-span-8">
                                <h2 className="text-lg font-semibold mb-3 flex items-center gap-2 text-indigo-900 sticky top-[70px] lg:static bg-white z-20 py-2 lg:py-0">
                                    <Calendar className="w-5 h-5 text-indigo-600" /> ตารางเวลา (11:30-12:30 และ 15:30-17:00)
                                </h2>
                                
                                {/* Scrollable Container */}
                                <div className="max-h-[60vh] lg:max-h-[600px] overflow-y-auto pr-1 sm:pr-2 custom-scroll border border-slate-200 rounded-xl p-2 sm:p-3 bg-slate-50/50">
                                    {/* Responsive Grid: ปรับจำนวนคอลัมน์ตามขนาดจอ เพิ่ม xl และ 2xl */}
                                    <div className="grid grid-cols-3 xs:grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-8 2xl:grid-cols-10 gap-2 sm:gap-3">
                                        {timeSlots.map((time) => {
                                            const isBooked = bookings[time];
                                            const isSelected = selectedTime === time;
                                            return (
                                                <div key={time} className="relative group">
                                                    <button 
                                                        onClick={() => !isBooked && setSelectedTime(time)} 
                                                        disabled={isBooked} 
                                                        className={`w-full py-2 px-1 sm:px-2 rounded-lg border text-sm font-medium flex flex-col items-center justify-center gap-1 min-h-[70px] sm:min-h-[80px] transition-all duration-200
                                                        ${isBooked 
                                                            ? 'bg-red-50 border-red-100 text-red-400 cursor-not-allowed' 
                                                            : isSelected 
                                                                ? 'bg-indigo-600 border-indigo-600 text-white scale-105 shadow-md ring-2 ring-indigo-200 z-10' 
                                                                : 'bg-white border-gray-200 text-gray-600 hover:border-indigo-400 hover:text-indigo-600 hover:shadow-sm'
                                                        }`}
                                                    >
                                                        <span className="text-sm sm:text-base font-bold">{time}</span>
                                                        {isBooked ? (
                                                            <span className="text-[10px] sm:text-xs truncate w-full text-center px-0.5 opacity-80">
                                                                {isBooked.name}
                                                            </span>
                                                        ) : (
                                                            <span className={`text-[10px] sm:text-xs ${isSelected ? 'text-indigo-200' : 'text-green-500'}`}>
                                                                ว่าง
                                                            </span>
                                                        )}
                                                    </button>
                                                    {/* ปุ่มลบ */}
                                                    {isBooked && (
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); openDeleteModal(time); }} 
                                                            className="absolute -top-1.5 -right-1.5 sm:-top-2 sm:-right-2 bg-white text-red-500 border border-red-100 p-1 rounded-full shadow-sm z-20 hover:bg-red-50 hover:text-red-600 lg:opacity-0 lg:group-hover:opacity-100 transition-opacity"
                                                            title="ยกเลิกการจอง"
                                                        >
                                                            <Trash2 className="w-3 h-3 sm:w-3.5 sm:h-3.5" />
                                                        </button>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Modal ยืนยันการลบ */}
                        {isModalOpen && (
                            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
                                <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full transform transition-all scale-100">
                                    <div className="flex flex-col items-center text-center">
                                        <div className="bg-red-100 p-4 rounded-full mb-4">
                                            <Trash2 className="w-8 h-8 text-red-600" />
                                        </div>
                                        <h3 className="text-xl font-bold text-gray-900 mb-2">ยืนยันการยกเลิก?</h3>
                                        <p className="text-gray-500 mb-6">คุณต้องการยกเลิกคิวเวลา <span className="font-bold text-gray-800 bg-gray-100 px-2 py-0.5 rounded">{timeToDelete} น.</span> ใช่หรือไม่?</p>
                                        <div className="flex gap-3 w-full">
                                            <button onClick={() => setIsModalOpen(false)} className="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 font-bold transition">
                                                ปิด
                                            </button>
                                            <button onClick={confirmDelete} className="flex-1 px-4 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 font-bold shadow-lg shadow-red-200 transition">
                                                ใช่, ลบเลย
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                    </div>
                    <div className="text-center text-gray-400 text-xs py-4">
                        ระบบจองคิว v1.2 (Full HD Support)
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<PhotoBookingApp />);
    </script>
</body>
</html>
