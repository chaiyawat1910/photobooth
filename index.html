<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MDPI Queue System (Matrix View)</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
    :root {
        --primary: #007aff;
        --danger: #ff3b30;
        --success: #34c759;
        --bg: #f5f5f7;
        --card: #ffffff;
    }
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: #1d1d1f; padding-bottom: 50px; }
    .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
    
    /* Header & Controls */
    .header { text-align: center; margin-bottom: 30px; }
    .control-bar {
        background: var(--card); padding: 20px; border-radius: 16px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;
    }
    .input-group { flex: 1; min-width: 200px; }
    label { display: block; font-size: 0.85em; color: #86868b; margin-bottom: 5px; font-weight: 600; }
    input, select { width: 100%; padding: 10px; border: 1px solid #d2d2d7; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
    
    /* MATRIX GRID */
    .matrix-container { overflow-x: auto; margin-top: 20px; background: var(--card); border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 20px; }
    table.matrix { width: 100%; border-collapse: collapse; min-width: 800px; }
    table.matrix th { text-align: left; padding: 15px; background: #f5f5f7; color: #1d1d1f; font-weight: 600; border-bottom: 2px solid #e5e5ea; }
    table.matrix td { padding: 10px; border-bottom: 1px solid #e5e5ea; border-right: 1px solid #e5e5ea; vertical-align: top; width: 30%; }
    table.matrix td:first-child { width: 10%; font-weight: bold; color: var(--primary); background: #fafafa; border-right: 2px solid #e5e5ea; text-align: center; vertical-align: middle; }
    
    /* Status Cards */
    .slot-card {
        padding: 12px; border-radius: 8px; font-size: 0.9em; transition: 0.2s; min-height: 80px; display: flex; flex-direction: column; justify-content: center;
    }
    .slot-empty {
        background: #e8f5e9; border: 1px dashed #4caf50; color: #2e7d32; cursor: pointer; text-align: center;
    }
    .slot-empty:hover { background: #c8e6c9; transform: translateY(-2px); }
    
    .slot-booked {
        background: #ffebee; border: 1px solid #ef9a9a; color: #c62828; position: relative;
    }
    .slot-booked strong { display: block; margin-bottom: 4px; font-size: 1.1em; }
    .slot-booked small { display: block; opacity: 0.8; }
    
    .admin-actions { margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); display: none; gap: 5px; }
    .admin-mode .admin-actions { display: flex; }
    
    button { cursor: pointer; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85em; font-weight: 600; }
    .btn-edit { background: #ff9500; color: white; }
    .btn-del { background: #ff3b30; color: white; }
    
    /* Modal */
    .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal-box { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 450px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
    .modal-header { font-size: 1.5em; font-weight: bold; margin-bottom: 20px; }
    .btn-submit { width: 100%; background: var(--primary); color: white; padding: 12px; font-size: 1em; margin-top: 20px; }
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ü™ú MDPI Booking Matrix</h1>
        <p style="color:#666">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ö‡∏±‡∏ô‡πÑ‡∏î (Business Days Only)</p>
    </div>

    <div class="control-bar">
        <div class="input-group">
            <label>üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
            <input type="date" id="datePicker">
        </div>
        <div class="input-group" style="flex:2; text-align:right;">
             <div id="adminPanel" style="display:none;">
                <span style="margin-right:10px; font-weight:bold; color:var(--primary);">üõ°Ô∏è Admin Mode</span>
                <button onclick="exportExcel()" style="background:#34c759; color:white;">Excel Export</button>
            </div>
            <div id="loginPanel">
                <input type="password" id="adminPass" placeholder="Admin Password" style="width:150px; display:inline-block;">
                <button onclick="loginAdmin()" style="background:#333; color:white;">Login</button>
            </div>
        </div>
    </div>

    <div class="matrix-container">
        <table class="matrix">
            <thead>
                <tr>
                    <th>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤</th>
                    <th>üìç Tower A ‡∏ä‡∏±‡πâ‡∏ô 26</th>
                    <th>üìç Tower A ‡∏ä‡∏±‡πâ‡∏ô 27</th>
                    <th>üìç Tower B ‡∏ä‡∏±‡πâ‡∏ô 22</th>
                </tr>
            </thead>
            <tbody id="matrixBody">
                </tbody>
        </table>
    </div>
</div>

<div id="bookingModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">üìù ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</div>
        <div style="background:#f5f5f7; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.9em;">
            <span id="modalDate">...</span> | <span id="modalTime">...</span><br>
            <strong id="modalLoc" style="color:var(--primary);">...</strong>
        </div>
        
        <label>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input id="inpName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠">
        <label>Email</label>
        <input id="inpEmail" placeholder="@mdpi.com">
        <label>‡πÅ‡∏ú‡∏ô‡∏Å</label>
        <select id="inpDept"></select>

        <input type="hidden" id="ctxLoc">
        <input type="hidden" id="ctxTime">
        <input type="hidden" id="ctxMode" value="create"> <input type="hidden" id="ctxId">

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="closeModal()" style="flex:1; background:#e5e5ea; color:#333;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button onclick="confirmBooking()" class="btn-submit" style="flex:2;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { 
        getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, getDoc,
        query, where, onSnapshot, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBWDvn67-_uW-OagSezI16kjbANVa4yAJI",
        authDomain: "my-queue-system-5b1d6.firebaseapp.com",
        projectId: "my-queue-system-5b1d6",
        storageBucket: "my-queue-system-5b1d6.firebasestorage.app",
        messagingSenderId: "57979958638",
        appId: "1:57979958638:web:82d71cc5654f304764fd7f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- CONFIG ---
    const ADMIN_PASS = "Mdpi@dm1n1996";
    const timeSlots = ["12:00 - 12:30", "15:00 - 15:20", "16:30 - 17:00", "17:00 - 17:30"];
    const locationMap = {
        "col1": "Tower A ‡∏ä‡∏±‡πâ‡∏ô 26",
        "col2": "Tower A ‡∏ä‡∏±‡πâ‡∏ô 27",
        "col3": "Tower B ‡∏ä‡∏±‡πâ‡∏ô 22"
    };
    const locationKeys = ["col1", "col2", "col3"];
    
    const departments = [
        "Editorial G1", "Editorial G2", "Editorial G3", "Editorial G4", "Editorial G5", 
        "Editorial G6", "Editorial G7", "Editorial G8", "Editorial G9", "Editorial G10", 
        "Editorial G11", "Editorial G12", "Editorial G13", "Editorial G14", "Editorial G15", 
        "Editorial G16", "Editorial G17", "Editorial G18", "Production G1", "Production G2", 
        "Production G3", "Production G4", "Production G5", "Production G6", "Admin", 
        "Conference", "Design", "Finance", "HR", "IT", "Proceedings", "Public Service", "Training"
    ];

    // --- STATE ---
    let currentData = [];
    let isAdmin = false;
    let unsubscribe = null;

    // --- UTILS: DATE LOGIC ---
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏Ç‡πâ‡∏≤‡∏° ‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå)
    const getNextBusinessDay = (dateStr) => {
        const d = new Date(dateStr);
        const day = d.getDay(); // 0=Sun, 6=Sat
        
        // ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå (0) -> ‡∏ö‡∏ß‡∏Å 1 ‡∏ß‡∏±‡∏ô (‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå)
        if (day === 0) d.setDate(d.getDate() + 1);
        // ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå (6) -> ‡∏ö‡∏ß‡∏Å 2 ‡∏ß‡∏±‡∏ô (‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå)
        else if (day === 6) d.setDate(d.getDate() + 2);
        
        return d.toISOString().split('T')[0];
    };

    // --- INIT ---
    const datePicker = document.getElementById("datePicker");
    
    // Default Today -> Check if Business Day
    const todayStr = new Date().toISOString().split('T')[0];
    datePicker.value = getNextBusinessDay(todayStr);

    datePicker.min = "2026-01-14";
    datePicker.max = "2026-01-26"; 
    
    document.getElementById("inpDept").innerHTML = departments.map(d => `<option>${d}</option>`).join("");

    // --- MAIN LOGIC: RENDER MATRIX ---
    const renderMatrix = (docs) => {
        const tbody = document.getElementById("matrixBody");
        tbody.innerHTML = "";
        
        // 1. Map Data
        const map = {};
        docs.forEach(d => {
            const data = d.data();
            if(!map[data.timeSlot]) map[data.timeSlot] = {};
            map[data.timeSlot][data.location] = { id: d.id, ...data };
        });

        // 2. Build Grid Rows
        timeSlots.forEach(time => {
            let rowHtml = `<tr><td>${time}</td>`;
            
            locationKeys.forEach(key => {
                const locName = locationMap[key];
                const booking = map[time] ? map[time][locName] : null;

                if (booking) {
                    // --- CASE: BOOKED ---
                    rowHtml += `
                    <td>
                        <div class="slot-card slot-booked">
                            <strong>${booking.name}</strong>
                            <small>${booking.department}</small>
                            <small style="font-size:0.8em; color:#d32f2f;">${booking.email}</small>
                            
                            <div class="admin-actions">
                                <button class="btn-edit" onclick="triggerEdit('${booking.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button class="btn-del" onclick="triggerDelete('${booking.id}')">‡∏•‡∏ö</button>
                            </div>
                        </div>
                    </td>`;
                } else {
                    // --- CASE: EMPTY ---
                    rowHtml += `
                    <td>
                        <div class="slot-card slot-empty" onclick="openBooking('${time}', '${locName}')">
                            ‚ûï ‡∏ß‡πà‡∏≤‡∏á<br><small>‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á</small>
                        </div>
                    </td>`;
                }
            });
            rowHtml += "</tr>";
            tbody.innerHTML += rowHtml;
        });
    };

    // --- REALTIME LISTENER (Modified) ---
    const loadData = () => {
        if(unsubscribe) unsubscribe();

        // VALIDATION: ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå
        const selectedDate = new Date(datePicker.value);
        const dayOfWeek = selectedDate.getDay();

        if (dayOfWeek === 0 || dayOfWeek === 6) {
            alert("‚ö†Ô∏è Policy Alert:\n‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏á‡∏ô‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå)\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥");
            
            // Auto-correct to next business day
            datePicker.value = getNextBusinessDay(datePicker.value);
            // Re-trigger loadData with correct date
            return loadData(); 
        }

        const date = datePicker.value;
        
        const q = query(
            collection(db, "queues"),
            where("date", "==", date)
        );

        unsubscribe = onSnapshot(q, (snap) => {
            currentData = snap.docs; // Keep for export
            renderMatrix(snap.docs);
        }, (err) => console.error(err));
    };

    // Initial Load
    loadData();
    datePicker.onchange = loadData;

    // --- ACTIONS ---
    window.openBooking = (time, loc) => {
        // Clear Inputs
        document.getElementById("inpName").value = "";
        document.getElementById("inpEmail").value = "";
        
        // Set Context
        document.getElementById("modalDate").innerText = datePicker.value;
        document.getElementById("modalTime").innerText = time;
        document.getElementById("modalLoc").innerText = loc;
        
        document.getElementById("ctxTime").value = time;
        document.getElementById("ctxLoc").value = loc;
        document.getElementById("ctxMode").value = "create";

        document.getElementById("bookingModal").style.display = "flex";
    };

    window.closeModal = () => document.getElementById("bookingModal").style.display = "none";

    window.confirmBooking = async () => {
        const btn = document.querySelector(".btn-submit");
        btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";

        const mode = document.getElementById("ctxMode").value;
        const id = document.getElementById("ctxId").value;
        const payload = {
            date: datePicker.value,
            timeSlot: document.getElementById("ctxTime").value,
            location: document.getElementById("ctxLoc").value,
            name: document.getElementById("inpName").value.trim(),
            email: document.getElementById("inpEmail").value.trim(),
            department: document.getElementById("inpDept").value,
            updatedAt: serverTimestamp()
        };

        if(!payload.name || !payload.email) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            btn.disabled = false; btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô";
            return;
        }

        try {
            const qRef = collection(db, "queues");

            if(mode === "create") {
                await addDoc(qRef, { ...payload, createdAt: serverTimestamp() });
            } else {
                await updateDoc(doc(db, "queues", id), payload);
            }

            closeModal();
        } catch(e) {
            alert("Error: " + e.message);
        } finally {
            btn.disabled = false; btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô";
        }
    };

    // --- ADMIN ACTIONS ---
    window.loginAdmin = () => {
        if(document.getElementById("adminPass").value === ADMIN_PASS) {
            isAdmin = true;
            document.body.classList.add("admin-mode"); // Use CSS to show buttons
            document.getElementById("loginPanel").style.display = "none";
            document.getElementById("adminPanel").style.display = "block";
            renderMatrix(currentData); // Re-render to show buttons
        } else {
            alert("Wrong Password");
        }
    };

    window.triggerDelete = async (id) => {
        if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) await deleteDoc(doc(db, "queues", id));
    };

    window.triggerEdit = async (id) => {
        // Fetch fresh data
        const d = await getDoc(doc(db, "queues", id));
        if(!d.exists()) return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
        const data = d.data();

        document.getElementById("ctxMode").value = "edit";
        document.getElementById("ctxId").value = id;
        document.getElementById("ctxTime").value = data.timeSlot;
        document.getElementById("ctxLoc").value = data.location;
        
        document.getElementById("modalDate").innerText = data.date;
        document.getElementById("modalTime").innerText = data.timeSlot;
        document.getElementById("modalLoc").innerText = data.location;

        document.getElementById("inpName").value = data.name;
        document.getElementById("inpEmail").value = data.email;
        document.getElementById("inpDept").value = data.department;

        document.getElementById("bookingModal").style.display = "flex";
    };

    window.exportExcel = () => {
        const data = currentData.map(d => d.data());
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        XLSX.writeFile(wb, `Schedule_${datePicker.value}.xlsx`);
    };
    
    // Expose functions globally
    window.openBooking = window.openBooking;
    window.triggerEdit = window.triggerEdit;
    window.triggerDelete = window.triggerDelete;
</script>

</body>
</html>
