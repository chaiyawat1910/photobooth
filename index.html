<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Queue System</title>

<!-- Excel Export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root {
--glass: rgba(255,255,255,.65);
--primary:#007aff;
}
body {
margin:0;
font-family:-apple-system,BlinkMacSystemFont,sans-serif;
background:linear-gradient(135deg,#dfe9f3,#fff);
}
.container {
max-width:1200px;
margin:40px auto;
padding:25px;
background:var(--glass);
backdrop-filter:blur(20px);
border-radius:22px;
box-shadow:0 20px 40px rgba(0,0,0,.15);
}
input,select,button {
width:100%;
padding:12px;
border-radius:12px;
border:1px solid #ddd;
margin:6px 0;
}
button {
background:var(--primary);
color:#fff;
border:none;
cursor:pointer;
}
button.danger { background:#ff3b30; }
table {
width:100%;
border-collapse:collapse;
margin-top:10px;
}
th,td {
padding:10px;
border-bottom:1px solid #eee;
text-align:center;
}
.glass {
background:rgba(255,255,255,.7);
border-radius:16px;
padding:15px;
margin:10px 0;
}
.admin-only { display:none; }
.highlight {
background:#ffeeba !important;
animation: blink 1s infinite;
}
@keyframes blink {
50% { background:#fff3cd; }
}
.alert {
background:#007aff;
color:#fff;
padding:15px;
border-radius:14px;
text-align:center;
font-size:20px;
display:none;
margin-bottom:15px;
}
</style>
</head>

<body>
<div class="container">
<h1>ü™ú ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡πÑ‡∏î</h1>

<div class="alert" id="notifyBox"></div>

<div class="glass">
<h2>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
<input id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
<input id="email" placeholder="Email">
<select id="department"></select>
<input type="date" id="queueDate">
<button id="addQueue">‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</button>
</div>

<div class="glass admin-only">
<h2>üìà Export</h2>
<button onclick="exportCSV()">Export CSV</button>
<button onclick="exportExcel()">Export Excel</button>
<button class="danger" onclick="callNext()">üîî ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
</div>

<div class="glass">
<h2>üìã Queue</h2>
<table>
<thead>
<tr>
<th>#</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>Email</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th class="admin-only">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
</tr>
</thead>
<tbody id="queueTable"></tbody>
</table>
</div>

<div class="glass">
<h2>üîê Admin</h2>
<input type="password" id="adminPass">
<button onclick="loginAdmin()">Login</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
getFirestore, collection, addDoc, deleteDoc, doc,
query, where, orderBy, onSnapshot, getDocs, setDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
apiKey:"AIzaSyBWDvn67-_uW-OagSezI16kjbANVa4yAJI",
authDomain:"my-queue-system-5b1d6.firebaseapp.com",
projectId:"my-queue-system-5b1d6",
storageBucket:"my-queue-system-5b1d6.firebasestorage.app",
messagingSenderId:"57979958638",
appId:"1:57979958638:web:82d71cc5654f304764fd7f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ADMIN_PASSWORD = "admin123";
let isAdmin = false;
let currentSnapshot = [];

const departments = [
"Editorial G1","Editorial G6","Editorial G10","Editorial G14","Editorial G15",
"Editorial G16","Editorial G2","Editorial G8","Editorial G12","Editorial G17",
"Editorial G4","Editorial G11","Editorial G3","Editorial G5","Editorial G7",
"Editorial G18","Editorial G9","Editorial G13",
"Production G1","Production G2","Production G3","Production G4","Production G5","Production G6",
"Admin","IT","Finance","HR","Conference","Design","Training","Proceedings","Public Service"
];
department.innerHTML = departments.map(d=>`<option>${d}</option>`).join("");
queueDate.valueAsDate = new Date();

/* -------- Add Queue (block email duplicate) -------- */
addQueue.onclick = async () => {
const q = query(
collection(db,"queues"),
where("email","==",email.value),
where("date","==",queueDate.value)
);
if(!(await getDocs(q)).empty){
alert("Email ‡∏ô‡∏µ‡πâ‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
return;
}
await addDoc(collection(db,"queues"),{
name:name.value,
email:email.value,
department:department.value,
date:queueDate.value,
createdAt:serverTimestamp()
});
};

/* -------- Render Queue -------- */
const render = snap => {
currentSnapshot = snap.docs;
queueTable.innerHTML="";
let i=1;
snap.forEach(d=>{
const q=d.data();
queueTable.innerHTML+=`
<tr id="${d.id}">
<td>${i++}</td>
<td>${q.name}</td>
<td>${q.email}</td>
<td>${q.department}</td>
<td>${q.createdAt?.toDate().toLocaleTimeString()||""}</td>
<td class="admin-only">
<button class="danger" onclick="deleteQ('${d.id}')">‚ùå</button>
</td>
</tr>`;
});
};

/* -------- Realtime Listener -------- */
onSnapshot(
query(
collection(db,"queues"),
where("date","==",queueDate.value),
orderBy("createdAt","asc")
),
render
);

/* -------- Admin -------- */
window.loginAdmin=()=>{
if(adminPass.value===ADMIN_PASSWORD){
isAdmin=true;
document.querySelectorAll(".admin-only").forEach(e=>e.style.display="block");
}
};

window.deleteQ=async id=>{
if(confirm("‡∏•‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏µ‡πâ?")) await deleteDoc(doc(db,"queues",id));
};

/* -------- Export -------- */
window.exportCSV=()=>{
let csv="Name,Email,Department,Time\n";
currentSnapshot.forEach(d=>{
const q=d.data();
csv+=`${q.name},${q.email},${q.department},${q.createdAt?.toDate()}\n`;
});
download(csv,"queue.csv","text/csv");
};

window.exportExcel=()=>{
const data=currentSnapshot.map(d=>d.data());
const ws=XLSX.utils.json_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Queue");
XLSX.writeFile(wb,"queue.xlsx");
};

function download(content,file,type){
const a=document.createElement("a");
a.href=URL.createObjectURL(new Blob([content],{type}));
a.download=file;
a.click();
}

/* -------- Call Next Queue -------- */
window.callNext=async ()=>{
if(!currentSnapshot.length)return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß");
const first=currentSnapshot[0];
await setDoc(doc(db,"notifications","current"),{
...first.data(),
calledAt:serverTimestamp()
});
await deleteDoc(first.ref);
};

/* -------- Notification Listener -------- */
onSnapshot(doc(db,"notifications","current"),snap=>{
if(!snap.exists())return;
const d=snap.data();
notifyBox.style.display="block";
notifyBox.innerText=`üîî ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß: ${d.name} (${d.department})`;
setTimeout(()=>notifyBox.style.display="none",8000);
});
</script>
</body>
</html>
