<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MDPI BKK ADMIN - ü™ú ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ö‡∏±‡∏ô‡πÑ‡∏î</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root {
    --glass: rgba(255,255,255,.85);
    --primary:#007aff;
    --danger:#ff3b30;
    --success:#34c759;
}
body {
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
    background:linear-gradient(135deg,#f5f7fa,#c3cfe2);
    min-height: 100vh;
    color: #333;
}
.container {
    max-width:1200px;
    margin:40px auto;
    padding:30px;
    background:rgba(255,255,255,0.4);
    backdrop-filter:blur(20px);
    border-radius:24px;
    box-shadow:0 20px 60px rgba(0,0,0,.1);
    border: 1px solid rgba(255,255,255,0.6);
}
h1, h2 { margin-top: 0; color: #1d1d1f; }
input,select,button {
    width:100%;
    padding:14px;
    box-sizing: border-box;
    border-radius:12px;
    border:1px solid #d1d1d6;
    margin:8px 0;
    font-size: 16px;
    background: rgba(255,255,255,0.9);
}
input:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0,122,255,0.2);
}
button {
    background:var(--primary);
    color:#fff;
    border:none;
    cursor:pointer;
    font-weight: 600;
    transition: all 0.2s;
}
button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,122,255,0.3); }
button:active { transform: translateY(0); }
button.danger { background:var(--danger); }
button.danger:hover { box-shadow: 0 4px 12px rgba(255,59,48,0.3); }

table { width:100%; border-collapse:separate; border-spacing: 0; margin-top:10px; }
th { background: rgba(0,0,0,0.05); font-weight: 600; color: #666; padding: 12px;}
td { padding:12px; border-bottom:1px solid #eee; text-align:center; background: rgba(255,255,255,0.5); }
tr:last-child td { border-bottom: none; }
tr:first-child td:first-child { border-top-left-radius: 12px; }
tr:first-child td:last-child { border-top-right-radius: 12px; }
tr:last-child td:first-child { border-bottom-left-radius: 12px; }
tr:last-child td:last-child { border-bottom-right-radius: 12px; }

.glass {
    background:var(--glass);
    border-radius:18px;
    padding:20px;
    margin-bottom:20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
}
.admin-only { display:none; }
.alert {
    background:var(--primary);
    color:#fff;
    padding:15px;
    border-radius:14px;
    text-align:center;
    font-size:18px;
    display:none;
    margin-bottom:20px;
    animation: slideDown 0.3s ease-out;
}
@keyframes slideDown { from { opacity:0; transform: translateY(-10px); } to { opacity:1; transform: translateY(0); } }

/* Tag Styles */
.tag { padding: 4px 8px; border-radius: 6px; font-size: 0.85em; font-weight: 600; }
.tag-loc { background: #e0f2fe; color: #0284c7; }
.tag-time { background: #fef3c7; color: #d97706; }
</style>
</head>

<body>
<div class="container">
    <h1>MDPI BKK ADMIN - ü™ú ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ö‡∏±‡∏ô‡πÑ‡∏î</h1>

    <div class="alert" id="notifyBox"></div>

    <div class="glass">
        <h2>üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏à‡∏≠‡∏á</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            <input id="email" placeholder="Email">
        </div>
        <select id="department"></select>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <select id="location">
                <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà --</option>
            </select>
            <input type="date" id="queueDate">
        </div>
        
        <select id="timeSlot">
            <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (30 ‡∏ô‡∏≤‡∏ó‡∏µ/‡∏£‡∏≠‡∏ö) --</option>
        </select>

        <button id="addQueue">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (Booking)</button>
    </div>

    <div class="glass admin-only">
        <h2>‚öôÔ∏è Admin Control</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button onclick="exportCSV()">Export CSV</button>
            <button onclick="exportExcel()">Export Excel</button>
        </div>
        <button class="danger" onclick="callNext()" style="margin-top:10px;">üîî ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    </div>

    <div class="glass">
        <h2>üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th class="admin-only">Action</th>
                    </tr>
                </thead>
                <tbody id="queueTable"></tbody>
            </table>
        </div>
    </div>

    <div class="glass">
        <h2>üîê Admin Login</h2>
        <input type="password" id="adminPass" placeholder="Mdpi@dm1n1996">
        <button onclick="loginAdmin()">Login</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
        getFirestore, collection, addDoc, deleteDoc, doc,
        query, where, orderBy, onSnapshot, getDocs, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // ‚ö†Ô∏è CONFIGURATION: ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤ Firebase Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.firebasestorage.app",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // SYSTEM CONSTANTS
    const ADMIN_PASSWORD = "admin123"; 
    
    // --- 1. Master Data Configuration ---
    const locations = [
        "Tower A ‡∏ä‡∏±‡πâ‡∏ô 22",
        "Tower B ‡∏ä‡∏±‡πâ‡∏ô 26",
        "Tower B ‡∏ä‡∏±‡πâ‡∏ô 27"
    ];

    const timeSlots = [
        "11:30 - 12:00",
        "12:00 - 12:30",
        "15:00 - 15:30"
    ];

    const departments = [
        "Editorial G1","Editorial G6","Editorial G10","Editorial G14","Editorial G15",
        "Editorial G16","Editorial G2","Editorial G8","Editorial G12","Editorial G17",
        "Editorial G4","Editorial G11","Editorial G3","Editorial G5","Editorial G7",
        "Editorial G18","Editorial G9","Editorial G13",
        "Production G1","Production G2","Production G3","Production G4","Production G5","Production G6",
        "Admin","IT","Finance","HR","Conference","Design","Training","Proceedings","Public Service"
    ];

    // --- 2. Initialize UI ---
    document.getElementById("department").innerHTML = departments.map(d => `<option>${d}</option>`).join("");
    
    document.getElementById("location").innerHTML += locations.map(l => `<option value="${l}">${l}</option>`).join("");
    
    document.getElementById("timeSlot").innerHTML += timeSlots.map(t => `<option value="${t}">${t}</option>`).join("");
    
    const qDateInput = document.getElementById("queueDate");
    qDateInput.valueAsDate = new Date();

    let currentSnapshot = [];
    let unsubscribe = null;
    let isAdmin = false;

    // --- 3. Booking Logic (Critical) ---
    document.getElementById("addQueue").onclick = async () => {
        const nameVal = document.getElementById("name").value.trim();
        const emailVal = document.getElementById("email").value.trim();
        const deptVal = document.getElementById("department").value;
        const locVal = document.getElementById("location").value;
        const timeVal = document.getElementById("timeSlot").value;
        const dateVal = qDateInput.value;

        // Validation 1: Required Fields
        if(!nameVal || !emailVal || !locVal || !timeVal || !dateVal) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà, ‡πÄ‡∏ß‡∏•‡∏≤, ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)");
            return;
        }

        const btn = document.getElementById("addQueue");
        btn.disabled = true;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";

        try {
            const queuesRef = collection(db, "queues");

            // Validation 2: Resource Availability (Is this Room taken at this Time?)
            // Logic: Same Date + Same Location + Same Time = Collision
            const resourceQuery = query(
                queuesRef,
                where("date", "==", dateVal),
                where("location", "==", locVal),
                where("timeSlot", "==", timeVal)
            );
            const resourceSnap = await getDocs(resourceQuery);
            if(!resourceSnap.empty){
                throw new Error(`‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à‡∏î‡πâ‡∏ß‡∏¢! ${locVal} ‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ${timeVal} ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß`);
            }

            // Validation 3: User Collision (Is this User booking another room at the same time?)
            // Logic: Same Date + Same Email + Same Time = Invalid (Cannot be in 2 places)
            const userQuery = query(
                queuesRef,
                where("date", "==", dateVal),
                where("email", "==", emailVal),
                where("timeSlot", "==", timeVal)
            );
            const userSnap = await getDocs(userQuery);
            if(!userSnap.empty){
                throw new Error(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ${timeVal} ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ)`);
            }

            // Execute Booking
            await addDoc(queuesRef, {
                name: nameVal,
                email: emailVal,
                department: deptVal,
                location: locVal,
                timeSlot: timeVal,
                date: dateVal,
                createdAt: serverTimestamp()
            });

            alert("‚úÖ ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            // Reset fields
            document.getElementById("location").value = "";
            document.getElementById("timeSlot").value = "";

        } catch (error) {
            console.error(error);
            alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (Booking)";
        }
    };

    // --- 4. Realtime Listener ---
    const subscribeQueue = () => {
        if(unsubscribe) unsubscribe();

        // Sort by TimeSlot then Location
        const q = query(
            collection(db,"queues"),
            where("date","==", qDateInput.value),
            orderBy("timeSlot", "asc"),
            orderBy("location", "asc")
        );

        unsubscribe = onSnapshot(q, (snap) => {
            currentSnapshot = snap.docs;
            const tbody = document.getElementById("queueTable");
            tbody.innerHTML = "";
            
            if(snap.empty) {
                tbody.innerHTML = "<tr><td colspan='5' style='padding:30px; color:#999;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>";
                return;
            }

            snap.forEach(d => {
                const data = d.data();
                tbody.innerHTML += `
                <tr id="${d.id}">
                    <td><span class="tag tag-time">${data.timeSlot}</span></td>
                    <td><span class="tag tag-loc">${data.location}</span></td>
                    <td style="font-weight:500;">${data.name}</td>
                    <td style="color:#666; font-size:0.9em;">${data.department}</td>
                    <td class="admin-only" style="${isAdmin ? 'display:block' : ''}">
                        <button class="danger" style="padding:6px 12px; font-size:0.8em;" onclick="deleteQ('${d.id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </td>
                </tr>`;
            });
            if(isAdmin) document.querySelectorAll(".admin-only").forEach(e => e.style.display = "block");
        }, (error) => {
            console.error("Snapshot Error:", error);
            if(error.code === 'failed-precondition') {
                alert("System Notice: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á Admin ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡πÉ‡∏ô Firestore (‡∏î‡∏π‡πÉ‡∏ô Console)");
            }
        });
    };

    subscribeQueue();
    qDateInput.onchange = subscribeQueue;

    // --- 5. Admin & Utilities ---
    window.loginAdmin = () => {
        if(document.getElementById("adminPass").value === ADMIN_PASSWORD){
            isAdmin = true;
            document.querySelectorAll(".admin-only").forEach(e => e.style.display = "block");
            subscribeQueue(); // Refresh to show buttons
        } else {
            alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î");
        }
    };

    window.deleteQ = async (id) => {
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏µ‡πâ?")) await deleteDoc(doc(db, "queues", id));
    };

    window.exportCSV = () => {
        let csv = "\uFEFFTime Slot,Location,Name,Email,Department,Date\n";
        currentSnapshot.forEach(d => {
            const q = d.data();
            csv += `"${q.timeSlot}","${q.location}","${q.name}","${q.email}","${q.department}","${q.date}"\n`;
        });
        download(csv, `booking_${qDateInput.value}.csv`, "text/csv;charset=utf-8");
    };

    window.exportExcel = () => {
        const data = currentSnapshot.map(d => {
            const q = d.data();
            return {
                Date: q.date,
                TimeSlot: q.timeSlot,
                Location: q.location,
                Name: q.name,
                Department: q.department,
                Email: q.email
            };
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Bookings");
        XLSX.writeFile(wb, `booking_${qDateInput.value}.xlsx`);
    };

    function download(content, file, type){
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([content], {type}));
        a.download = file;
        a.click();
    }

    // --- 6. Calling Queue (Modified for Logic) ---
    window.callNext = async () => {
        if(!currentSnapshot.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å");
        
        // Find the earliest slot
        const first = currentSnapshot[0]; 
        const d = first.data();

        if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å: ${d.name} \n‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${d.location} \n‡πÄ‡∏ß‡∏•‡∏≤: ${d.timeSlot}`)) {
             await setDoc(doc(db,"notifications","current"), {
                ...d,
                calledAt: serverTimestamp()
            });
            // Note: In booking systems, we usually DON'T delete the record when called, 
            // but for this specific "Queue" logic requested, I will keep the delete behavior 
            // or maybe we should just mark it as 'completed'?
            // Following previous logic: Delete after call.
            await deleteDoc(first.ref);
        }
    };

    // Notification Listener
    onSnapshot(doc(db,"notifications","current"), snap => {
        if(!snap.exists()) return;
        const d = snap.data();
        const box = document.getElementById("notifyBox");
        box.style.display = "block";
        box.innerHTML = `üîî <b>‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß</b><br>${d.name} (${d.department})<br>üìç ${d.location} ‚è∞ ${d.timeSlot}`;
        setTimeout(() => box.style.display = "none", 10000);
    });

</script>
</body>
</html>
