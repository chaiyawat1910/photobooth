<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MDPI ADMIN Queue System</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root {
    --glass: rgba(255,255,255,0.95);
    --primary: #007aff;
    --danger: #ff3b30;
    --disabled: #8e8e93;
    --bg-gradient: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
}
body {
    margin:0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg-gradient);
    min-height: 100vh;
    color: #333;
}
.container {
    max-width: 1200px;
    margin: 30px auto;
    padding: 30px;
    background: rgba(255,255,255,0.25);
    backdrop-filter: blur(25px);
    border-radius: 24px;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    border: 1px solid rgba(255, 255, 255, 0.18);
}
h1, h2 { margin-top: 0; color: #1d1d1f; }
input, select, button {
    width: 100%;
    padding: 12px;
    box-sizing: border-box;
    border-radius: 10px;
    border: 1px solid #ccc;
    margin: 6px 0;
    font-size: 15px;
}
input:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0,122,255,0.2);
}
button {
    background: var(--primary);
    color: #fff;
    border: none;
    cursor: pointer;
    font-weight: 600;
    text-transform: uppercase;
    transition: 0.2s;
}
button:hover:not(:disabled) { filter: brightness(1.1); }
button:disabled {
    background: var(--disabled);
    cursor: not-allowed;
    opacity: 0.7;
}
button.danger { background: var(--danger); }

/* Table */
.table-wrapper { overflow-x: auto; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
table { width: 100%; border-collapse: collapse; background: #fff; }
th { background: #f8f9fa; font-weight: 600; color: #495057; padding: 12px; text-align: left; }
td { padding: 12px; border-bottom: 1px solid #eee; }

.glass {
    background: #fff;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.admin-only { display: none; }
.alert {
    background: var(--primary);
    color: #fff;
    padding: 15px;
    border-radius: 14px;
    text-align: center;
    font-size: 18px;
    display: none;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,122,255,0.4);
}
.badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
.bg-loc { background-color: #e3f2fd; color: #0d47a1; }
.bg-time { background-color: #fff3e0; color: #e65100; }
</style>
</head>

<body>
<div class="container">
    <h1>ü™ú MDPI Queue System</h1>
    <div style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
        üìÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á: 14 - 23 ‡∏°.‡∏Ñ. 2026 | ‚è∞ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î: 14 ‡∏°.‡∏Ñ. (13:00) - 26 ‡∏°.‡∏Ñ. (18:00)
    </div>

    <div class="alert" id="notifyBox"></div>
    <div class="alert" id="systemStatusBox" style="background: #ff3b30; display:none;"></div>

    <div class="glass">
        <h2>üìù ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡πÑ‡∏î</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            <input id="email" placeholder="Email">
        </div>
        <select id="department"></select>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <select id="location">
                <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà --</option>
            </select>
            <input type="date" id="queueDate">
        </div>
        
        <select id="timeSlot">
            <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (30 ‡∏ô‡∏≤‡∏ó‡∏µ/‡∏£‡∏≠‡∏ö) --</option>
        </select>

        <button id="addQueue">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
    </div>

    <div class="glass admin-only">
        <h2>‚öôÔ∏è Admin Control</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button onclick="exportCSV()">Download CSV</button>
            <button onclick="exportExcel()">Download Excel</button>
        </div>
        <button class="danger" onclick="callNext()" style="margin-top:10px;">üîî ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    </div>

    <div class="glass">
        <h2>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="displayDate"></span>)</h2>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th class="admin-only">Action</th>
                    </tr>
                </thead>
                <tbody id="queueTable"></tbody>
            </table>
        </div>
    </div>

    <div class="glass">
        <h2>üîê Admin Login</h2>
        <input type="password" id="adminPass" placeholder="Password">
        <button onclick="loginAdmin()">Login</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
    import {
        getFirestore, collection, addDoc, deleteDoc, doc,
        query, where, orderBy, onSnapshot, getDocs, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ‚úÖ CONFIGURATION
    const firebaseConfig = {
        apiKey: "AIzaSyBWDvn67-_uW-OagSezI16kjbANVa4yAJI",
        authDomain: "my-queue-system-5b1d6.firebaseapp.com",
        projectId: "my-queue-system-5b1d6",
        storageBucket: "my-queue-system-5b1d6.firebasestorage.app",
        messagingSenderId: "57979958638",
        appId: "1:57979958638:web:82d71cc5654f304764fd7f",
        measurementId: "G-WNP7J2F96C"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // --- SYSTEM POLICIES ---
    const ADMIN_PASSWORD = "Mdpi@dm1n1996"; 
    
    // 1. Time Slots
    const timeSlots = [
        "12:00 - 12:30", 
        "15:00 - 15:20", 
        "16:30 - 17:00", 
        "17:00 - 17:30"
    ];

    // 2. Booking Date Range (YYYY-MM-DD)
    const ALLOWED_DATE_START = "2026-01-14";
    const ALLOWED_DATE_END = "2026-01-23";

    // 3. System Access Window (Date Object)
    const SYSTEM_OPEN_TIME = new Date("2026-01-14T13:00:00");
    const SYSTEM_CLOSE_TIME = new Date("2026-01-26T18:00:00");

    const locations = ["Tower A ‡∏ä‡∏±‡πâ‡∏ô 22", "Tower B ‡∏ä‡∏±‡πâ‡∏ô 26", "Tower B ‡∏ä‡∏±‡πâ‡∏ô 27"];
    
    // ‚úÖ Departments: Sorted Alphabetically
    const departments = [
        "Editorial G1",
        "Editorial G10",
        "Editorial G11",
        "Editorial G12",
        "Editorial G13",
        "Editorial G14",
        "Editorial G15",
        "Editorial G16",
        "Editorial G17",
        "Editorial G18",
        "Editorial G2",
        "Editorial G3",
        "Editorial G4",
        "Editorial G5",
        "Editorial G6",
        "Editorial G7",
        "Editorial G8",
        "Editorial G9",
        "Production G1",
        "Production G2",
        "Production G3",
        "Production G4",
        "Production G5",
        "Production G6",
        "Admin",
        "Conference",
        "Design",
        "Finance",
        "HR",
        "IT",
        "Proceedings",
        "Public Service",
        "Training"
    ];

    // --- INITIALIZATION ---
    document.getElementById("department").innerHTML = departments.map(d => `<option>${d}</option>`).join("");
    document.getElementById("location").innerHTML += locations.map(l => `<option value="${l}">${l}</option>`).join("");
    document.getElementById("timeSlot").innerHTML += timeSlots.map(t => `<option value="${t}">${t}</option>`).join("");
    
    // Set Date Picker Constraints
    const qDateInput = document.getElementById("queueDate");
    qDateInput.min = ALLOWED_DATE_START;
    qDateInput.max = ALLOWED_DATE_END;
    qDateInput.value = ALLOWED_DATE_START; 

    let currentSnapshot = [];
    let unsubscribe = null;
    let isAdmin = false;

    // --- ACCESS CONTROL CHECKER ---
    function checkSystemStatus() {
        if (isAdmin) return true; // Admin Bypass

        const now = new Date();
        const btn = document.getElementById("addQueue");
        const statusBox = document.getElementById("systemStatusBox");

        if (now < SYSTEM_OPEN_TIME || now > SYSTEM_CLOSE_TIME) {
            btn.disabled = true;
            btn.innerText = "‚õî ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß";
            statusBox.style.display = "block";
            statusBox.innerText = `‚õî ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô 14/01/26 13:00 - 26/01/26 18:00)`;
            return false;
        } else {
            btn.disabled = false;
            btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á";
            statusBox.style.display = "none";
            return true;
        }
    }

    checkSystemStatus();
    setInterval(checkSystemStatus, 60000);

    // --- CORE LOGIC: BOOKING ---
    document.getElementById("addQueue").onclick = async () => {
        if (!checkSystemStatus()) return;

        const name = document.getElementById("name").value.trim();
        const email = document.getElementById("email").value.trim();
        const dept = document.getElementById("department").value;
        const loc = document.getElementById("location").value;
        const time = document.getElementById("timeSlot").value;
        const date = qDateInput.value;

        if(!name || !email || !loc || !time || !date) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");

        if(date < ALLOWED_DATE_START || date > ALLOWED_DATE_END) {
            return alert(`‚ùå ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (${ALLOWED_DATE_START} ‡∏ñ‡∏∂‡∏á ${ALLOWED_DATE_END})`);
        }

        const btn = document.getElementById("addQueue");
        btn.disabled = true;
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";

        try {
            const qRef = collection(db, "queues");

            // 1. Resource Availability Check
            const roomCheck = await getDocs(query(qRef, 
                where("date", "==", date),
                where("location", "==", loc),
                where("timeSlot", "==", time)
            ));
            if(!roomCheck.empty) throw new Error(`${loc} ‡∏£‡∏≠‡∏ö ${time} ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß`);

            // 2. User Duplicate Check
            const userCheck = await getDocs(query(qRef,
                where("date", "==", date),
                where("email", "==", email),
                where("timeSlot", "==", time)
            ));
            if(!userCheck.empty) throw new Error(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ${time} ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß`);

            // 3. Commit
            await addDoc(qRef, {
                name, email, department: dept, location: loc, timeSlot: time, date,
                createdAt: serverTimestamp()
            });

            alert("‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            document.getElementById("location").value = "";
            document.getElementById("timeSlot").value = "";

        } catch (e) {
            alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + e.message);
            console.error(e);
        } finally {
            checkSystemStatus(); 
        }
    };

    // --- REALTIME LISTENER ---
    const subscribeQueue = () => {
        if(unsubscribe) unsubscribe();
        document.getElementById("displayDate").innerText = qDateInput.value;

        const q = query(
            collection(db,"queues"),
            where("date","==", qDateInput.value),
            orderBy("timeSlot", "asc"),
            orderBy("location", "asc")
        );

        unsubscribe = onSnapshot(q, (snap) => {
            currentSnapshot = snap.docs;
            const tbody = document.getElementById("queueTable");
            tbody.innerHTML = "";
            
            if(snap.empty) {
                tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:30px; color:#999;'>‡∏ß‡πà‡∏≤‡∏á (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</td></tr>";
            } else {
                snap.forEach(d => {
                    const data = d.data();
                    tbody.innerHTML += `
                    <tr>
                        <td><span class="badge bg-time">${data.timeSlot}</span></td>
                        <td><span class="badge bg-loc">${data.location}</span></td>
                        <td>${data.name}</td>
                        <td>${data.department}</td>
                        <td class="admin-only" style="${isAdmin ? 'display:block' : ''}">
                            <button class="danger" onclick="deleteQ('${d.id}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </td>
                    </tr>`;
                });
            }
            if(isAdmin) document.querySelectorAll(".admin-only").forEach(e => e.style.display = "block");
        }, (error) => {
            console.error("Firestore Error:", error);
            if(error.code === 'failed-precondition') {
                alert("System Notice: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Console (F12) ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏•‡∏¥‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡πÉ‡∏ô Firebase");
            }
        });
    };

    subscribeQueue();
    qDateInput.onchange = subscribeQueue;

    // --- ADMIN MODULE ---
    window.loginAdmin = () => {
        const inputPass = document.getElementById("adminPass").value;
        if(inputPass === ADMIN_PASSWORD){
            isAdmin = true;
            document.querySelectorAll(".admin-only").forEach(e => e.style.display = "block");
            checkSystemStatus();
            subscribeQueue(); 
            alert("Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö");
        } else {
            alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        }
    };

    window.deleteQ = async (id) => {
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏µ‡πâ?")) await deleteDoc(doc(db,"queues",id));
    };

    window.exportCSV = () => {
        let csv = "\uFEFFTime,Location,Name,Department,Email,Date\n";
        currentSnapshot.forEach(d => {
            const q = d.data();
            csv += `"${q.timeSlot}","${q.location}","${q.name}","${q.department}","${q.email}","${q.date}"\n`;
        });
        download(csv, `queue_${qDateInput.value}.csv`, "text/csv;charset=utf-8");
    };

    window.exportExcel = () => {
        const data = currentSnapshot.map(d => {
            const q = d.data();
            return { Date: q.date, Time: q.timeSlot, Place: q.location, Name: q.name, Dept: q.department, Email: q.email };
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Bookings");
        XLSX.writeFile(wb, `queue_${qDateInput.value}.xlsx`);
    };

    function download(content, file, type){
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([content],{type}));
        a.download = file;
        a.click();
    }

    // --- CALL QUEUE ---
    window.callNext = async () => {
        if(!currentSnapshot.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
        const first = currentSnapshot[0].data();
        await setDoc(doc(db,"notifications","current"), { ...first, calledAt: serverTimestamp() });
        await deleteDoc(currentSnapshot[0].ref);
    };

    onSnapshot(doc(db,"notifications","current"), snap => {
        if(!snap.exists()) return;
        const d = snap.data();
        const box = document.getElementById("notifyBox");
        box.style.display = "block";
        box.innerHTML = `üîî <b>‡∏Ç‡∏≠‡πÄ‡∏ä‡∏¥‡∏ç‡∏Ñ‡∏∏‡∏ì ${d.name}</b><br>üìç ${d.location} | ‚è∞ ${d.timeSlot}`;
        setTimeout(() => box.style.display = "none", 10000);
    });
</script>
</body>
</html>
